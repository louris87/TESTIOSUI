<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BEST FRIEND SEAMAN AGENCY - Command Center</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      /* Default Theme - Dark Navy (Main) */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: rgba(30, 41, 59, 0.7);
      --bg-input: rgba(15, 23, 42, 0.6);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border-color: rgba(148, 163, 184, 0.2);
      --border-light: rgba(203, 213, 225, 0.3);
      --primary-color: #60a5fa;
      --secondary-color: #8b5cf6;
      --accent-color: #38bdf8;
      --success-color: #4ade80;
      --warning-color: #fbbf24;
      --danger-color: #f87171;
      --info-color: #22d3ee;
      --glass-bg: rgba(30, 41, 59, 0.6);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --gradient-primary: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      --theme-name: 'dark';
    }

    :root[data-theme="light"] {
      /* Light Theme - White/Modern */
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-input: rgba(248, 250, 252, 0.9);
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --border-color: rgba(203, 213, 225, 0.5);
      --border-light: rgba(148, 163, 184, 0.3);
      --primary-color: #3b82f6;
      --secondary-color: #8b5cf6;
      --accent-color: #0ea5e9;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #06b6d4;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: 1px solid rgba(203, 213, 225, 0.5);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      --gradient-bg: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
      --theme-name: 'light';
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    body {
      background: var(--gradient-bg);
      background-attachment: fixed;
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      font-family: 'Open Sans', sans-serif;
    }
    
    body[data-theme="dark"]::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 30%, rgba(96, 165, 250, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(56, 189, 248, 0.1) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    body[data-theme="light"]::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(14, 165, 233, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    body[data-theme="dark"] ::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
    }
    
    body[data-theme="light"] ::-webkit-scrollbar-track {
      background: rgba(226, 232, 240, 0.5);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--gradient-primary);
      border-radius: 10px;
    }
    
    body[data-theme="dark"] ::-webkit-scrollbar-thumb {
      border: 2px solid rgba(30, 41, 59, 0.5);
    }
    
    body[data-theme="light"] ::-webkit-scrollbar-thumb {
      border: 2px solid rgba(226, 232, 240, 0.5);
    }
    
    ::-webkit-scrollbar-thumb:hover {
      filter: brightness(1.2);
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Theme Switcher */
    .theme-switcher {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }
    
    .theme-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--gradient-primary);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1) rotate(180deg);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .theme-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
    }
    
    .theme-toggle:hover::before {
      animation: shimmer 0.6s;
    }
    
    @keyframes shimmer {
      100% {
        transform: translateX(100%);
      }
    }
    
    /* Header */
    header {
      background: var(--glass-bg);
      border: var(--glass-border);
      padding: 20px 30px;
      border-radius: 20px;
      margin-bottom: 40px;
      box-shadow: var(--glass-shadow);
      position: sticky;
      top: 20px;
      z-index: 1000;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 2px solid var(--primary-color);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 26px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.5px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      padding-left: 50px;
    }
    
    h1::before {
      content: 'âš“';
      position: absolute;
      left: 0;
      font-size: 32px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sync-status {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      font-weight: 500;
      background: var(--bg-input);
      padding: 10px 20px;
      border-radius: 50px;
      border: var(--glass-border);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
    }
    
    .sync-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: relative;
    }
    
    .sync-indicator::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .sync-indicator.connected {
      background-color: var(--success-color);
    }
    
    body[data-theme="dark"] .sync-indicator.connected::before {
      background: rgba(74, 222, 128, 0.4);
    }
    
    body[data-theme="light"] .sync-indicator.connected::before {
      background: rgba(16, 185, 129, 0.4);
    }
    
    .sync-indicator.syncing {
      background-color: var(--warning-color);
    }
    
    body[data-theme="dark"] .sync-indicator.syncing::before {
      background: rgba(251, 191, 36, 0.4);
    }
    
    body[data-theme="light"] .sync-indicator.syncing::before {
      background: rgba(245, 158, 11, 0.4);
    }
    
    .sync-indicator.error {
      background-color: var(--danger-color);
    }
    
    body[data-theme="dark"] .sync-indicator.error::before {
      background: rgba(248, 113, 113, 0.4);
    }
    
    body[data-theme="light"] .sync-indicator.error::before {
      background: rgba(239, 68, 68, 0.4);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    #userEmail {
      font-size: 14px;
      color: var(--text-muted);
      background: var(--bg-input);
      padding: 8px 16px;
      border-radius: 50px;
      border: var(--glass-border);
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    /* Buttons */
    .btn-group {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--border-color);
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.6s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button i {
      font-size: 16px;
      transition: transform 0.3s;
    }
    
    button:hover i {
      transform: scale(1.2);
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      border: none !important;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(96, 165, 250, 0.3);
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary:hover {
      background: var(--bg-secondary);
      transform: translateY(-3px) scale(1.02);
      border-color: var(--border-light);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .logout-btn {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
      border: 1px solid rgba(248, 113, 113, 0.3) !important;
      color: #fca5a5;
      padding: 10px 20px;
      font-size: 13px;
      box-shadow: 0 4px 15px rgba(248, 113, 113, 0.1);
    }
    
    body[data-theme="light"] .logout-btn {
      color: #ef4444;
    }
    
    .logout-btn:hover {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.2) 0%, rgba(239, 68, 68, 0.2) 100%);
      color: white;
      border-color: var(--danger-color) !important;
      box-shadow: 0 8px 25px rgba(248, 113, 113, 0.2);
    }
    
    /* Card Action Buttons */
    .btn-edit {
      background: var(--gradient-primary);
      border: none;
      color: white;
      padding: 10px 18px;
      font-size: 12px;
      border-radius: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(96, 165, 250, 0.1);
    }
    
    .btn-edit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(96, 165, 250, 0.2);
    }
    
    .btn-delete {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.2) 0%, rgba(239, 68, 68, 0.2) 100%);
      border: 1px solid rgba(248, 113, 113, 0.3) !important;
      color: #fca5a5;
      padding: 10px 18px;
      font-size: 12px;
      border-radius: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(248, 113, 113, 0.1);
    }
    
    body[data-theme="light"] .btn-delete {
      color: #ef4444;
    }
    
    .btn-delete:hover {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.3) 0%, rgba(239, 68, 68, 0.3) 100%);
      color: white;
      border-color: var(--danger-color) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(248, 113, 113, 0.2);
    }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
      background: var(--glass-bg);
      border-radius: 20px;
      backdrop-filter: blur(20px) saturate(180%);
      border: var(--glass-border);
      margin: 20px 0;
    }
    
    .spinner {
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
      position: relative;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }
    
    /* Containers */
    .search-container,
    .form-container,
    .login-container,
    .title-dialog {
      background: var(--glass-bg);
      border: var(--glass-border);
      padding: 40px;
      border-radius: 24px;
      box-shadow: var(--glass-shadow);
      margin-bottom: 30px;
      animation: fadeIn 0.5s ease;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 2px solid var(--primary-color);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form Elements */
    input,
    select,
    textarea {
      width: 100%;
      padding: 16px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 15px;
      transition: all 0.4s;
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    input:hover,
    select:hover,
    textarea:hover {
      border-color: var(--primary-color);
      opacity: 0.8;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
      background: var(--bg-card);
    }
    
    label {
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 10px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }
    
    .search-container {
      display: none;
    }
    
    .search-box {
      display: flex;
      gap: 20px;
    }
    
    .form-container {
      display: none;
    }
    
    .form-title {
      font-size: 28px;
      margin-bottom: 30px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 15px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .form-title i {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 30px;
    }
    
    /* Checkbox Groups */
    .checkbox-group {
      background: var(--bg-input);
      padding: 30px;
      border-radius: 18px;
      border: 1px solid var(--border-color);
      margin-top: 30px;
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    .checkbox-section-title {
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
      margin-bottom: 20px;
      font-size: 17px;
      font-weight: 600;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .checkbox-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 20px;
    }
    
    .checkbox-item {
      background: var(--bg-card);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }
    
    .checkbox-item:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .checkbox-item label {
      text-transform: none;
      letter-spacing: normal;
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 400;
      font-size: 14px;
    }
    
    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
      accent-color: var(--primary-color);
    }
    
    /* Login */
    .login-container {
      display: none;
      max-width: 480px;
      margin: 10vh auto;
      text-align: center;
      border-top: 4px solid var(--primary-color);
    }
    
    .login-container h2 {
      margin-bottom: 30px;
      color: var(--text-primary);
      font-size: 32px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .login-btn {
      width: 100%;
      justify-content: center;
      margin-top: 30px;
      padding: 18px;
      font-size: 16px;
      background: var(--gradient-primary);
      color: white !important;
      border: none !important;
      box-shadow: 0 8px 25px rgba(96, 165, 250, 0.3) !important;
    }
    
    .login-btn:hover {
      box-shadow: 0 12px 30px rgba(96, 165, 250, 0.4) !important;
      transform: translateY(-3px) !important;
    }
    
    /* Profile Cards */
    .profile-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 30px;
    }
    
    .profile-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 20px 40px -20px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
    }
    
    .profile-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--gradient-primary);
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    
    .profile-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 30px 50px -20px rgba(0, 0, 0, 0.3);
      border-color: var(--primary-color);
      background: var(--bg-secondary);
    }
    
    .profile-card:hover::before {
      opacity: 1;
    }
    
    .card-header {
      background: var(--bg-input);
      padding: 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
    }
    
    .card-header-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .card-avatar {
      width: 60px;
      height: 60px;
      background: var(--gradient-primary);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(96, 165, 250, 0.3);
    }
    
    .card-header h3 {
      font-size: 20px;
      color: var(--text-primary);
      margin-bottom: 5px;
    }
    
    .card-header p {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .card-actions {
      display: flex;
      gap: 12px;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .card-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed var(--border-color);
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .card-detail:hover {
      border-bottom-color: var(--primary-color);
    }
    
    .card-detail:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .detail-label i {
      font-size: 14px;
      color: var(--primary-color);
    }
    
    .detail-value {
      color: var(--text-secondary);
      font-weight: 500;
      text-align: right;
    }
    
    /* Progress Bar */
    .progress-bar {
      height: 8px;
      background-color: var(--bg-input);
      border-radius: 10px;
      margin-top: 12px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .progress {
      height: 100%;
      background: var(--gradient-primary);
      border-radius: 10px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 2s infinite;
    }
    
    /* No Results */
    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: 80px;
      color: var(--text-muted);
      background: var(--bg-input);
      border-radius: 20px;
      border: 2px dashed var(--border-color);
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    .no-results i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Footer */
    footer {
      text-align: center;
      margin-top: 80px;
      padding: 40px;
      color: var(--text-muted);
      font-size: 14px;
      border-top: 1px solid var(--border-color);
      background: var(--glass-bg);
      border-radius: 20px;
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    /* Title Dialog */
    .title-dialog {
      display: none;
      max-width: 700px;
      margin: 0 auto;
      text-align: center;
    }
    
    .title-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-top: 40px;
    }
    
    .title-option {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 40px 25px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    .title-option:hover {
      background: var(--bg-card);
      transform: translateY(-8px) scale(1.03);
      border-color: var(--primary-color);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    
    .title-option.active {
      background: var(--bg-secondary);
      border-color: var(--primary-color);
      box-shadow: 0 0 30px rgba(96, 165, 250, 0.3);
    }
    
    .title-option i {
      font-size: 48px;
      margin-bottom: 20px;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: transform 0.3s;
    }
    
    .title-option:hover i {
      transform: scale(1.2);
    }
    
    .title-option h3,
    .title-option h4 {
      color: var(--text-secondary);
      margin-bottom: 10px;
      font-size: 20px;
    }
    
    .title-option p {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    /* Sub Options */
    .sub-options {
      display: none;
      margin-top: 30px;
      padding: 30px;
      background: var(--bg-input);
      border-radius: 18px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    .sub-options.active {
      display: block;
    }
    
    /* Webcam */
    .webcam-container {
      grid-column: 1 / -1;
      background: var(--bg-input);
      padding: 30px;
      border-radius: 18px;
      border: 1px solid var(--border-color);
      margin-top: 30px;
      backdrop-filter: blur(20px) saturate(180%);
    }
    
    .webcam-preview {
      width: 100%;
      max-width: 450px;
      height: 350px;
      background: var(--bg-card);
      border-radius: 15px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 2px solid var(--border-color);
      position: relative;
    }
    
    .webcam-preview video,
    .webcam-preview canvas,
    .webcam-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 13px;
    }
    
    .webcam-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    /* Date Search */
    .date-search {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .date-search input {
      flex: 1;
    }
    
    /* Utility Classes */
    .hidden-field {
      display: none;
    }
    
    /* Form Actions */
    .form-actions {
      text-align: center;
      margin-top: 50px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      header {
        padding: 15px 20px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      h1 {
        font-size: 20px;
        padding-left: 40px;
      }
      
      h1::before {
        font-size: 24px;
      }
      
      .theme-switcher {
        bottom: 20px;
        right: 20px;
      }
      
      .theme-toggle {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      
      .title-options {
        grid-template-columns: 1fr;
      }
      
      .profile-cards {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .search-box,
      .date-search {
        flex-direction: column;
      }
      
      .btn-group {
        justify-content: center;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="theme-switcher">
    <button class="theme-toggle" id="themeToggle" title="Switch Theme">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <div class="container">
    <header>
      <div class="header-content">
        <h1>BEST FRIEND SEAMAN AGENCY</h1>
        <div class="sync-status">
          <div class="sync-indicator" id="syncIndicator"></div>
          <span id="syncStatus">System Initializing...</span>
        </div>
        <div class="user-info" id="userInfo" style="display:none">
          <span id="userEmail">user@example.com</span>
          <button id="logoutBtn" class="logout-btn"><i class="fa-solid fa-power-off"></i> Logout</button>
        </div>
      </div>
    </header>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p id="loadingText">Processing data...</p>
    </div>

    <div id="loginContainer" class="login-container">
      <h2>Welcome Back</h2>
      <form id="loginForm" class="login-form">
        <div class="form-group" style="margin-bottom:25px;text-align:left">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="Enter your email" required/>
        </div>
        <div class="form-group" style="margin-bottom:25px;text-align:left">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required/>
        </div>
        <button type="submit" class="login-btn btn-primary">Access System</button>
      </form>
    </div>

    <div id="mainContent" style="display:none">
      <div class="btn-group">
        <button id="addDataBtn" class="btn-primary"><i class="fa-solid fa-plus"></i> Add Profile</button>
        <button id="searchBtn" class="btn-secondary"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
        <button id="exportBtn" class="btn-secondary" style="margin-left:auto"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
      </div>

      <div id="searchContainer" class="search-container">
        <h3 style="margin-bottom:20px; color: var(--text-secondary);">Search Database</h3>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Type name, rank, or CDC number..."/>
          <button id="searchSubmit" class="btn-primary">Search</button>
        </div>
        <div class="date-search">
          <input type="date" id="dateFrom" placeholder="From Date"/>
          <input type="date" id="dateTo" placeholder="To Date"/>
          <button id="dateSearch" class="btn-secondary">Search by Date</button>
        </div>
      </div>

      <!-- Title Selection Dialog -->
      <div id="titleDialog" class="title-dialog">
        <h2 class="form-title"><i class="fa-solid fa-file-lines"></i> Select Document Type</h2>
        <div class="title-options">
          <div class="title-option" id="newCDCOption">
            <i class="fa-solid fa-file-circle-plus"></i>
            <h3>NEW CDC</h3>
            <p>Create new CDC document</p>
          </div>
          <div class="title-option" id="revalidationOption">
            <i class="fa-solid fa-file-pen"></i>
            <h3>REVALIDATION</h3>
            <p>Update existing CDC</p>
          </div>
        </div>

        <div class="sub-options" id="revalidationSubOptions">
          <h4 style="color: var(--text-secondary); margin-bottom: 20px; font-size: 18px;">Select Revalidation Type</h4>
          <div class="title-options" style="grid-template-columns:1fr 1fr;margin-top:20px">
            <div class="title-option" id="crewOption">
              <i class="fa-solid fa-user"></i>
              <h4>CREW</h4>
            </div>
            <div class="title-option" id="officerOption">
              <i class="fa-solid fa-user-tie"></i>
              <h4>OFFICER</h4>
            </div>
          </div>

          <!-- Dialog-only docs -->
          <div class="checkbox-group hidden-field" id="crewDocsTemplate">
            <div class="checkbox-section-title">Crew Documents</div>
            <div class="checkbox-row">
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="4-Ticket" id="crew_4ticket"><label for="crew_4ticket">4-Ticket</label></div>
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="PSC" id="crew_psc"><label for="crew_psc">PSC</label></div>
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="TANKER" id="crew_TANKER"><label for="crew_TANKER">TANKER</label></div>
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="CMC" id="crew_cmc"><label for="crew_cmc">CMC</label></div>
            </div>
          </div>

          <div class="checkbox-group hidden-field" id="officerDocsTemplate">
            <div class="checkbox-section-title">Officer Documents</div>
            <div class="checkbox-row">
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="AFF" id="off_aff"><label for="off_aff">AFF</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="PSC" id="off_psc"><label for="off_psc">PSC</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="MFA" id="off_mfa"><label for="off_mfa">MFA</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="CMC" id="off_cmc"><label for="off_cmc">CMC</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="G.O.C" id="off_gdc"><label for="off_gdc">G.O.C</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="C.O.C" id="off_cdc"><label for="off_cdc">C.O.C</label></div>
            </div>
          </div>
        </div>

        <div style="margin-top:40px; display: flex; gap: 20px; justify-content: center;">
          <button id="confirmTitle" class="btn-primary">Confirm Selection</button>
          <button id="cancelTitle" class="btn-secondary">Cancel</button>
        </div>
      </div>

      <!-- Main Form Container -->
      <div id="formContainer" class="form-container">
        <h2 class="form-title"><i class="fa-solid fa-user-pen"></i> <span id="formTitleText">New Profile Registration</span></h2>
        <form id="profileForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="name">Full Name</label>
              <input type="text" id="name" required/>
            </div>
            <div class="form-group">
              <label for="rank">Rank</label>
              <select id="rank" required>
                <option value="">Select Rank</option>
              </select>
            </div>
            <div class="form-group">
              <label for="cdcNumber">CDC Number</label>
              <input type="text" id="cdcNumber" required/>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" required/>
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <textarea id="address" required rows="1"></textarea>
            </div>
            <div class="form-group">
              <label for="passportNumber">Passport Number</label>
              <input type="text" id="passportNumber"/>
            </div>
            <div class="form-group">
              <label for="passportExpiry">Passport Expiry Date</label>
              <input type="text" id="passportExpiry" placeholder="DD/MM/YYYY"/>
            </div>

            <!-- NEW CDC Only -->
            <div class="form-group hidden-field new-cdc-only">
              <label for="nrc">NRC Number</label>
              <input type="text" id="nrc" placeholder="e.g., 12/ABC(N)123456"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="fatherName">Father's Name</label>
              <input type="text" id="fatherName"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="motherName">Mother's Name</label>
              <input type="text" id="motherName"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="birthdate">Birthdate (DD/MM/YYYY)</label>
              <input type="text" id="birthdate" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="placeOfBirth">Place of Birth</label>
              <input type="text" id="placeOfBirth" placeholder="e.g., Yangon, Myanmar"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="distinguishingMark">Distinguishing Mark</label>
              <input type="text" id="distinguishingMark" placeholder="Visible marks"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="fees">Fees Amount ($)</label>
              <input type="number" id="fees"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="feesPercentage">Payment Status (%)</label>
              <input type="number" id="feesPercentage" min="0" max="100"/>
              <div class="progress-bar"><div class="progress" id="feesProgress"></div></div>
            </div>

            <div class="form-group" style="grid-column:1/-1">
              <label for="remark">Remark</label>
              <textarea id="remark" rows="3" placeholder="Additional notes..."></textarea>
            </div>
          </div>

          <!-- Webcam -->
          <div class="webcam-container">
            <div class="checkbox-section-title">Profile Photo</div>
            <div class="webcam-preview" id="webcamPreview">
              <i class="fa-solid fa-camera" style="font-size:60px;opacity:.5; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>
            </div>
            <div class="webcam-controls">
              <button type="button" id="startCamera" class="btn-secondary"><i class="fa-solid fa-camera"></i> Start Camera</button>
              <button type="button" id="capturePhoto" class="btn-secondary" disabled><i class="fa-solid fa-camera-retro"></i> Capture</button>
              <button type="button" id="retakePhoto" class="btn-secondary" disabled><i class="fa-solid fa-rotate-left"></i> Retake</button>
            </div>
            <input type="hidden" id="profilePhoto"/>
          </div>

          <!-- Revalidation docs -->
          <div id="revalidationDocsContainer" class="checkbox-group hidden-field"></div>

          <!-- NEW CDC docs -->
          <div class="checkbox-group hidden-field new-cdc-only">
            <div class="checkbox-section">
              <div class="checkbox-section-title">Core Documents</div>
              <div class="checkbox-row">
                <div class="checkbox-item"><input type="checkbox" id="bst" name="certificates" value="BST"><label for="bst">BST</label></div>
                <div class="checkbox-item"><input type="checkbox" id="pd" name="certificates" value="PD"><label for="pd">PD</label></div>
                <div class="checkbox-item"><input type="checkbox" id="pe" name="certificates" value="PE"><label for="pe">PE</label></div>
                <div class="checkbox-item"><input type="checkbox" id="cck" name="certificates" value="CCK"><label for="cck">CCK</label></div>
              </div>
            </div>
            <div class="checkbox-section">
              <div class="checkbox-section-title">Additional Docs</div>
              <div class="checkbox-row">
                <div class="checkbox-item"><input type="checkbox" id="ssa" name="certificates" value="SSA"><label for="ssa">SSA</label></div>
                <div class="checkbox-item"><input type="checkbox" id="dsd" name="certificates" value="DSD"><label for="dsd">DSD</label></div>
                <div class="checkbox-item"><input type="checkbox" id="cdc" name="certificates" value="CDC"><label for="cdc">CDC</label></div>
                <div class="checkbox-item"><input type="checkbox" id="cmc" name="certificates" value="CMC"><label for="cmc">CMC</label></div>
              </div>
            </div>
            <div class="checkbox-section">
              <div class="checkbox-section-title">Special</div>
              <div class="checkbox-row">
                <div class="checkbox-item"><input type="checkbox" id="pscSpecial" name="certificates" value="PSC"><label for="pscSpecial">PSC</label></div>
                <div class="checkbox-item"><input type="checkbox" id="tff" name="certificates" value="TFF"><label for="tff">TFF</label></div>
                <div class="checkbox-item"><input type="checkbox" id="aio" name="certificates" value="AIO"><label for="aio">AIO</label></div>
                <div class="checkbox-item"><input type="checkbox" id="sid" name="certificates" value="SID"><label for="sid">SID</label></div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" id="saveBtn"><i class="fa-solid fa-save"></i> Save Record</button>
            <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
            <button type="button" id="updateBtn" class="btn-primary hidden-field"><i class="fa-solid fa-edit"></i> Update Record</button>
          </div>
        </form>
      </div>

      <div id="profileCards" class="profile-cards">
        <div class="no-results" id="noResults">
          <i class="fa-solid fa-cloud-arrow-down"></i><br/>
          Connecting to Database...
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 BEST FRIEND SEAMAN AGENCY Systems. All rights reserved.</p>
    </footer>
  </div>

  <script>
    const firebaseConfig={
      apiKey:"AIzaSyDP34-uI6YNf56YUax0zLQ7y_TWad52rA0",
      authDomain:"seameandatabase.firebaseapp.com",
      projectId:"seameandatabase",
      storageBucket:"seameandatabase.firebasestorage.app",
      messagingSenderId:"1078604355486",
      appId:"G-16GVDL26Q3"
    };

    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    const auth=firebase.auth();

    let profiles=[];
    let selectedTitle='';
    let selectedRevalidationType='';
    let stream=null;
    let capturedPhoto=null;
    let editingProfileId = null;

    // Theme Management
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const root = document.documentElement;

    // Initialize theme from localStorage or default to dark
    const savedTheme = localStorage.getItem('seaman-theme') || 'dark';
    body.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    // Theme toggle event
    themeToggle.addEventListener('click', toggleTheme);

    function toggleTheme() {
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('seaman-theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = themeToggle.querySelector('i');
      if (theme === 'dark') {
        icon.className = 'fas fa-moon';
        themeToggle.title = 'Switch to Light Mode';
      } else {
        icon.className = 'fas fa-sun';
        themeToggle.title = 'Switch to Dark Mode';
      }
    }

    const loading=document.getElementById('loading');
    const loadingText=document.getElementById('loadingText');
    const syncIndicator=document.getElementById('syncIndicator');
    const syncStatus=document.getElementById('syncStatus');
    const loginContainer=document.getElementById('loginContainer');
    const loginForm=document.getElementById('loginForm');
    const mainContent=document.getElementById('mainContent');
    const userInfo=document.getElementById('userInfo');
    const userEmail=document.getElementById('userEmail');
    const logoutBtn=document.getElementById('logoutBtn');
    const exportBtn=document.getElementById('exportBtn');
    const addDataBtn=document.getElementById('addDataBtn');
    const searchBtn=document.getElementById('searchBtn');
    const searchContainer=document.getElementById('searchContainer');
    const formContainer=document.getElementById('formContainer');
    const profileForm=document.getElementById('profileForm');
    const profileCards=document.getElementById('profileCards');
    const searchInput=document.getElementById('searchInput');
    const searchSubmit=document.getElementById('searchSubmit');
    const dateFrom=document.getElementById('dateFrom');
    const dateTo=document.getElementById('dateTo');
    const dateSearch=document.getElementById('dateSearch');
    const cancelBtn=document.getElementById('cancelBtn');
    const noResults=document.getElementById('noResults');
    const feesPercentage=document.getElementById('feesPercentage');
    const feesProgress=document.getElementById('feesProgress');
    const formTitleText = document.getElementById('formTitleText');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');

    const titleDialog=document.getElementById('titleDialog');
    const newCDCOption=document.getElementById('newCDCOption');
    const revalidationOption=document.getElementById('revalidationOption');
    const revalidationSubOptions=document.getElementById('revalidationSubOptions');
    const crewOption=document.getElementById('crewOption');
    const officerOption=document.getElementById('officerOption');
    const confirmTitle=document.getElementById('confirmTitle');
    const cancelTitle=document.getElementById('cancelTitle');

    const crewDocsTemplate=document.getElementById('crewDocsTemplate');
    const officerDocsTemplate=document.getElementById('officerDocsTemplate');
    const revalidationDocsContainer=document.getElementById('revalidationDocsContainer');

    const webcamPreview=document.getElementById('webcamPreview');
    const startCamera=document.getElementById('startCamera');
    const capturePhoto=document.getElementById('capturePhoto');
    const retakePhoto=document.getElementById('retakePhoto');
    const profilePhoto=document.getElementById('profilePhoto');
    const rankSelect=document.getElementById('rank');

    document.addEventListener('DOMContentLoaded',initApp);
    loginForm.addEventListener('submit',loginUser);
    logoutBtn.addEventListener('click',logoutUser);
    exportBtn.addEventListener('click',exportToCSV);
    addDataBtn.addEventListener('click',showTitleDialog);
    searchBtn.addEventListener('click',showSearch);
    profileForm.addEventListener('submit',saveProfile);
    searchSubmit.addEventListener('click',searchProfiles);
    dateSearch.addEventListener('click',searchByDate);
    cancelBtn.addEventListener('click',hideForm);
    updateBtn.addEventListener('click', updateProfile);
    feesPercentage.addEventListener('input',updateProgressBar);

    newCDCOption.addEventListener('click',()=>selectTitle('NEW CDC'));
    revalidationOption.addEventListener('click',()=>selectTitle('REVALIDATION'));
    crewOption.addEventListener('click',()=>selectRevalidationType('CREW'));
    officerOption.addEventListener('click',()=>selectRevalidationType('OFFICER'));
    confirmTitle.addEventListener('click',confirmTitleSelection);
    cancelTitle.addEventListener('click',hideTitleDialog);

    startCamera.addEventListener('click',startWebcam);
    capturePhoto.addEventListener('click',captureWebcam);
    retakePhoto.addEventListener('click',retakeWebcam);

    function initApp(){
      updateSyncStatus('Initializing Firebase...','syncing');
      auth.onAuthStateChanged(user=>{
        if(user){
          userEmail.textContent=user.email;
          userInfo.style.display='flex';
          loginContainer.style.display='none';
          mainContent.style.display='block';
          updateSyncStatus('System Online','connected');
          loadDataFromFirebase();
        }else{
          userInfo.style.display='none';
          loginContainer.style.display='block';
          mainContent.style.display='none';
          updateSyncStatus('Authentication Required','error');
        }
      });
    }

    async function loginUser(e){
      e.preventDefault();
      const email=document.getElementById('email').value;
      const password=document.getElementById('password').value;
      showLoading('Authenticating...');
      try{
        await auth.signInWithEmailAndPassword(email,password);
      }catch(err){
        alert('Login failed: '+err.message);
      }finally{hideLoading()}
    }

    async function logoutUser(){
      showLoading('Terminating session...');
      try{await auth.signOut()}catch(err){/* noop */}finally{hideLoading()}
    }

    function updateSyncStatus(message,status='connected'){
      syncStatus.textContent=message;
      syncIndicator.className='sync-indicator '+status;
    }

    async function loadDataFromFirebase(){
      showLoading('Fetching records...');
      try{
        const snapshot=await db.collection('profiles').orderBy('timestamp','desc').get();
        profiles=[];
        snapshot.forEach(doc=>{const p=doc.data();p.id=doc.id;profiles.push(p)});
        updateSyncStatus(`Online - ${profiles.length} Records`,'connected');
        displayProfiles(profiles);
      }catch(error){
        try{
          const snapshot=await db.collection('profiles').get();
          profiles=[];
          snapshot.forEach(doc=>{const p=doc.data();p.id=doc.id;profiles.push(p)});
          displayProfiles(profiles);
        }catch(e){
          updateSyncStatus('Connection Error','error');
        }
      }finally{hideLoading()}
    }

    async function saveProfile(e){
      e.preventDefault();
      const selectedCertificates=[];
      if(selectedTitle==='NEW CDC'){
        document.querySelectorAll('input[name="certificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
      }else if(selectedTitle==='REVALIDATION'){
        if(selectedRevalidationType==='CREW'){
          revalidationDocsContainer.querySelectorAll('input[name="crewCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }else if(selectedRevalidationType==='OFFICER'){
          revalidationDocsContainer.querySelectorAll('input[name="officerCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }
      }

      const profile={
        name:document.getElementById('name').value,
        rank:document.getElementById('rank').value,
        cdcNumber:document.getElementById('cdcNumber').value,
        phone:document.getElementById('phone').value,
        address:document.getElementById('address').value,
        passportNumber:document.getElementById('passportNumber').value,
        passportExpiry:document.getElementById('passportExpiry').value,
        remark:document.getElementById('remark').value,
        title:selectedTitle,
        revalidationType:selectedRevalidationType,
        profilePhoto:capturedPhoto,
        certificates:selectedCertificates.join(', '),
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
      };

      if(selectedTitle==='NEW CDC'){
        profile.nrc=document.getElementById('nrc').value;
        profile.fatherName=document.getElementById('fatherName').value;
        profile.motherName=document.getElementById('motherName').value;
        profile.birthdate=document.getElementById('birthdate').value;
        profile.placeOfBirth=document.getElementById('placeOfBirth').value;
        profile.distinguishingMark=document.getElementById('distinguishingMark').value;
        profile.fees=document.getElementById('fees').value;
        profile.feesPercentage=document.getElementById('feesPercentage').value;
      }

      showLoading('Uploading to cloud...');
      try{
        await db.collection('profiles').add(profile);
        alert('Success: Profile archived in database.');
        hideForm();
        await loadDataFromFirebase();
      }catch(err){
        alert('Error: '+err.message);
      }finally{hideLoading()}
    }

    async function updateProfile() {
      if (!editingProfileId) return;
      
      const selectedCertificates=[];
      if(selectedTitle==='NEW CDC'){
        document.querySelectorAll('input[name="certificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
      }else if(selectedTitle==='REVALIDATION'){
        if(selectedRevalidationType==='CREW'){
          revalidationDocsContainer.querySelectorAll('input[name="crewCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }else if(selectedRevalidationType==='OFFICER'){
          revalidationDocsContainer.querySelectorAll('input[name="officerCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }
      }

      const profile={
        name:document.getElementById('name').value,
        rank:document.getElementById('rank').value,
        cdcNumber:document.getElementById('cdcNumber').value,
        phone:document.getElementById('phone').value,
        address:document.getElementById('address').value,
        passportNumber:document.getElementById('passportNumber').value,
        passportExpiry:document.getElementById('passportExpiry').value,
        remark:document.getElementById('remark').value,
        title:selectedTitle,
        revalidationType:selectedRevalidationType,
        profilePhoto:capturedPhoto || document.getElementById('profilePhoto').value,
        certificates:selectedCertificates.join(', '),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if(selectedTitle==='NEW CDC'){
        profile.nrc=document.getElementById('nrc').value;
        profile.fatherName=document.getElementById('fatherName').value;
        profile.motherName=document.getElementById('motherName').value;
        profile.birthdate=document.getElementById('birthdate').value;
        profile.placeOfBirth=document.getElementById('placeOfBirth').value;
        profile.distinguishingMark=document.getElementById('distinguishingMark').value;
        profile.fees=document.getElementById('fees').value;
        profile.feesPercentage=document.getElementById('feesPercentage').value;
      }

      showLoading('Updating profile...');
      try{
        await db.collection('profiles').doc(editingProfileId).update(profile);
        alert('Success: Profile updated.');
        hideForm();
        await loadDataFromFirebase();
      }catch(err){
        alert('Error: '+err.message);
      }finally{
        hideLoading();
        editingProfileId = null;
      }
    }

    async function deleteProfile(profileId) {
      if (!confirm('Are you sure you want to delete this profile?')) return;
      
      showLoading('Deleting profile...');
      try {
        await db.collection('profiles').doc(profileId).delete();
        profiles = profiles.filter(p => p.id !== profileId);
        displayProfiles(profiles);
        updateSyncStatus(`Online - ${profiles.length} Records`, 'connected');
        alert('Profile deleted successfully.');
      } catch (err) {
        alert('Error deleting profile: ' + err.message);
      } finally {
        hideLoading();
      }
    }

    function editProfile(profile) {
      editingProfileId = profile.id;
      selectedTitle = profile.title || '';
      selectedRevalidationType = profile.revalidationType || '';
      
      // Populate form fields
      document.getElementById('name').value = profile.name || '';
      document.getElementById('cdcNumber').value = profile.cdcNumber || '';
      document.getElementById('phone').value = profile.phone || '';
      document.getElementById('address').value = profile.address || '';
      document.getElementById('passportNumber').value = profile.passportNumber || '';
      document.getElementById('passportExpiry').value = profile.passportExpiry || '';
      document.getElementById('remark').value = profile.remark || '';
      
      // Set profile photo if exists
      if (profile.profilePhoto) {
        capturedPhoto = profile.profilePhoto;
        profilePhoto.value = profile.profilePhoto;
        webcamPreview.innerHTML = `<img src="${profile.profilePhoto}" alt="Profile Photo">`;
      }
      
      // Handle NEW CDC specific fields
      if (profile.title === 'NEW CDC') {
        document.getElementById('nrc').value = profile.nrc || '';
        document.getElementById('fatherName').value = profile.fatherName || '';
        document.getElementById('motherName').value = profile.motherName || '';
        document.getElementById('birthdate').value = profile.birthdate || '';
        document.getElementById('placeOfBirth').value = profile.placeOfBirth || '';
        document.getElementById('distinguishingMark').value = profile.distinguishingMark || '';
        document.getElementById('fees').value = profile.fees || '';
        document.getElementById('feesPercentage').value = profile.feesPercentage || '';
        updateProgressBar();
        
        // Check certificates checkboxes
        if (profile.certificates) {
          const certs = profile.certificates.split(', ');
          document.querySelectorAll('input[name="certificates"]').forEach(cb => {
            cb.checked = certs.includes(cb.value);
          });
        }
      }
      
      // Handle REVALIDATION
      if (profile.title === 'REVALIDATION') {
        // Check certificates checkboxes
        if (profile.certificates) {
          const certs = profile.certificates.split(', ');
          const certsContainer = selectedRevalidationType === 'CREW' ? 
            'crewCertificates' : 'officerCertificates';
          
          // We need to render the revalidation docs first
          renderRevalidationDocsIntoForm();
          revalidationDocsContainer.querySelectorAll(`input[name="${certsContainer}"]`).forEach(cb => {
            cb.checked = certs.includes(cb.value);
          });
        }
      }
      
      // Update form UI - IMPORTANT: Call updateFormFields BEFORE setting rank value
      formTitleText.textContent = 'Edit Profile';
      saveBtn.classList.add('hidden-field');
      updateBtn.classList.remove('hidden-field');
      
      // First update the rank options based on title and revalidation type
      updateFormFields();
      
      // THEN set the rank value - This is the FIX for rank selection issue
      setTimeout(() => {
        document.getElementById('rank').value = profile.rank || '';
      }, 50);
      
      formContainer.style.display = 'block';
      formContainer.scrollIntoView({behavior: 'smooth'});
    }

    async function exportToCSV(){
      if(profiles.length===0){alert('No data to export');return}
      showLoading('Generating CSV...');
      try{
        let csv="Name,Rank,CDC Number,Phone,Address,Passport Number,Passport Expiry,Title,Revalidation Type,Remark,Certificates";
        if(profiles.some(p=>p.title==='NEW CDC')){
          csv+=",NRC,Father's Name,Mother's Name,Birthdate,Place of Birth,Distinguishing Mark,Fees,Fees Percentage";
        }
        csv+="\n";
        profiles.forEach(p=>{
          const row=[
            `"${p.name}"`,`"${p.rank}"`,`"${p.cdcNumber}"`,`"${p.phone}"`,`"${p.address}"`,
            `"${p.passportNumber||''}"`,`"${p.passportExpiry||''}"`,`"${p.title||''}"`,`"${p.revalidationType||''}"`,
            `"${p.remark||''}"`,`"${p.certificates||''}"`
          ];
          if(p.title==='NEW CDC'){
            row.push(
              `"${p.nrc||''}"`,`"${p.fatherName||''}"`,`"${p.motherName||''}"`,`"${p.birthdate||''}"`,
              `"${p.placeOfBirth||''}"`,`"${p.distinguishingMark||''}"`,`"${p.fees||''}"`,`"${p.feesPercentage||''}"`
            );
          }
          csv+=row.join(',')+"\n";
        });
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;a.download='seaman_profiles_export.csv';a.style.visibility='hidden';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
        updateSyncStatus('Export Complete','connected');
      }catch(err){alert('Export failed: '+err.message)}finally{hideLoading()}
    }

    function showLoading(text='Processing...'){loadingText.textContent=text;loading.style.display='block'}
    function hideLoading(){loading.style.display='none'}

    function showTitleDialog(){
      titleDialog.style.display='block';
      searchContainer.style.display='none';
      formContainer.style.display='none';
      resetTitleOptions();
      titleDialog.scrollIntoView({behavior:'smooth'});
    }

    function hideTitleDialog(){
      titleDialog.style.display='none';
      revalidationDocsContainer.innerHTML='';
      revalidationDocsContainer.classList.add('hidden-field');
    }

    function selectTitle(title){
      selectedTitle=title;
      if(title==='NEW CDC'){
        newCDCOption.classList.add('active');
        revalidationOption.classList.remove('active');
        revalidationSubOptions.classList.remove('active');
      }else if(title==='REVALIDATION'){
        revalidationOption.classList.add('active');
        newCDCOption.classList.remove('active');
        revalidationSubOptions.classList.add('active');
      }
    }

    function selectRevalidationType(type){
      selectedRevalidationType=type;
      if(type==='CREW'){
        crewOption.classList.add('active');
        officerOption.classList.remove('active');
      }else{
        officerOption.classList.add('active');
        crewOption.classList.remove('active');
      }
    }

    function confirmTitleSelection(){
      if(!selectedTitle){alert('Please select a document type');return}
      if(selectedTitle==='REVALIDATION' && !selectedRevalidationType){alert('Please select a revalidation type');return}
      hideTitleDialog();
      showForm();
      renderRevalidationDocsIntoForm();
    }

    function renderRevalidationDocsIntoForm(){
      revalidationDocsContainer.innerHTML='';
      revalidationDocsContainer.classList.add('hidden-field');
      if(selectedTitle!=='REVALIDATION') return;

      const source=(selectedRevalidationType==='CREW')?crewDocsTemplate:officerDocsTemplate;
      if(!source) return;

      const clone=source.cloneNode(true);
      clone.removeAttribute('id');
      clone.querySelectorAll('input[type="checkbox"]').forEach(cb=>{cb.checked=false;cb.disabled=false;});
      clone.classList.remove('hidden-field');
      clone.style.display='block';

      revalidationDocsContainer.appendChild(clone);
      revalidationDocsContainer.classList.remove('hidden-field');
    }

    function resetTitleOptions(){
      selectedTitle='';selectedRevalidationType='';
      [newCDCOption,revalidationOption,crewOption,officerOption,revalidationSubOptions].forEach(el=>el.classList.remove('active'));
      revalidationDocsContainer.innerHTML='';
      revalidationDocsContainer.classList.add('hidden-field');
      document.querySelectorAll('input[name="crewCertificates"],input[name="officerCertificates"]').forEach(cb=>cb.checked=false);
    }

    function showForm(){
      formContainer.style.display='block';
      searchContainer.style.display='none';
      profileForm.reset();
      updateProgressBar();
      editingProfileId = null;

      formTitleText.textContent = 'New Profile Registration';
      saveBtn.classList.remove('hidden-field');
      updateBtn.classList.add('hidden-field');

      if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}
      webcamPreview.innerHTML='<i class="fa-solid fa-camera" style="font-size:60px;opacity:.5; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>';
      capturedPhoto=null;capturePhoto.disabled=true;retakePhoto.disabled=true;

      updateFormFields();
      formContainer.scrollIntoView({behavior:'smooth'});
    }

    function updateFormFields(){
      const newCDCOnlyFields=document.querySelectorAll('.new-cdc-only');
      if(selectedTitle==='NEW CDC'){
        newCDCOnlyFields.forEach(f=>f.classList.remove('hidden-field'));
        // Store current rank value before resetting options
        const currentRank = rankSelect.value;
        
        // Set NEW CDC ranks
        rankSelect.innerHTML=`
          <option value="">Select Rank</option>
          <option value="D/R">D/R</option>
          <option value="E/R">E/R</option>
          <option value="ET/R">ET/R</option>
          <option value="G/S">G/S</option>
          <option value="C/CK">C/CK</option>
        `;
        
        // Restore rank value if editing
        if (editingProfileId && currentRank) {
          rankSelect.value = currentRank;
        }
        
        revalidationDocsContainer.classList.add('hidden-field');
        revalidationDocsContainer.innerHTML='';
      }else if(selectedTitle==='REVALIDATION'){
        newCDCOnlyFields.forEach(f=>f.classList.add('hidden-field'));
        
        // Store current rank value before resetting options
        const currentRank = rankSelect.value;
        
        if(selectedRevalidationType==='OFFICER'){
          rankSelect.innerHTML=`
            <option value="">Select Officer Rank</option>
            <option value="Master">Master</option>
            <option value="C/O">C/O</option>
            <option value="2/O">2/O</option>
            <option value="3/O">3/O</option>
            <option value="C/E">C/E</option>
            <option value="2/E">2/E</option>
            <option value="3/E">3/E</option>
            <option value="4/E">4/E</option>
            <option value="E/E">E/E</option>
          `;
        }else{
          rankSelect.innerHTML=`
            <option value="">Select Crew Rank</option>
            <option value="BSN">BSN</option>
            <option value="A/B">A/B</option>
            <option value="O/S">O/S</option>
            <option value="FTR">FTR</option>
            <option value="OLR">OLR</option>
            <option value="WPR">WPR</option>
            <option value="D/C">D/C</option>
            <option value="E/C">E/C</option>
            <option value="Cruise Crew">Cruise Crew</option>
          `;
        }
        
        // Restore rank value if editing
        if (editingProfileId && currentRank) {
          rankSelect.value = currentRank;
        }
      }
    }

    function hideForm(){
      formContainer.style.display='none';
      resetTitleOptions();
      editingProfileId = null;
    }

    function showSearch(){
      searchContainer.style.display='block';
      formContainer.style.display='none';
      titleDialog.style.display='none';
      searchContainer.scrollIntoView({behavior:'smooth'});
    }

    function updateProgressBar(){
      const pct=Number(feesPercentage.value||0);
      feesProgress.style.width=`${pct}%`;
      if(pct<30) feesProgress.style.background='#ef4444';
      else if(pct<70) feesProgress.style.background='#f59e0b';
      else feesProgress.style.background='#10b981';
    }

    function searchProfiles(){
      const term=(searchInput.value||'').toLowerCase();
      const filtered=profiles.filter(p=>
        (p.name&&p.name.toLowerCase().includes(term))||
        (p.rank&&p.rank.toLowerCase().includes(term))||
        (p.cdcNumber&&p.cdcNumber.toLowerCase().includes(term))
      );
      displayProfiles(filtered);
    }

    function searchByDate(){
      const fromDate=dateFrom.value,toDate=dateTo.value;
      if(!fromDate&&!toDate){alert('Please enter at least one date');return}
      const filtered=profiles.filter(p=>{
        if(!p.timestamp) return false;
        const d=new Date(p.timestamp.seconds*1000);
        const from=fromDate?new Date(fromDate):new Date(0);
        const to=toDate?new Date(toDate):new Date();
        from.setHours(0,0,0,0);to.setHours(23,59,59,999);
        return d>=from && d<=to;
      });
      displayProfiles(filtered);
    }

    function displayProfiles(list){
      profileCards.innerHTML='';
      if(list.length===0){
        noResults.innerHTML='<i class="fa-solid fa-magnifying-glass"></i><br>No matching profiles found.';
        noResults.style.display='block';
        profileCards.appendChild(noResults);
        return;
      }
      noResults.style.display='none';
      list.forEach(p=>{
        const card=document.createElement('div');card.className='profile-card';
        const initials=p.name?p.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase():'??';
        card.innerHTML=`
          <div class="card-header">
            <div class="card-header-info">
              <div class="card-avatar">${initials}</div>
              <div><h3>${p.name}</h3><p>${p.rank}</p></div>
            </div>
            <div class="card-actions">
              <button class="btn-edit" data-id="${p.id}"><i class="fa-solid fa-edit"></i></button>
              <button class="btn-delete" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="card-body">
            <div class="card-details">
              <div class="card-detail"><span class="detail-label"><i class="fa-regular fa-id-card"></i> CDC</span><span class="detail-value">${p.cdcNumber}</span></div>
              <div class="card-detail"><span class="detail-label"><i class="fa-solid fa-phone"></i> Phone</span><span class="detail-value">${p.phone}</span></div>
              <div class="card-detail"><span class="detail-label"><i class="fa-solid fa-file"></i> Type</span><span class="detail-value">${p.title||'N/A'}</span></div>
              ${p.certificates?`<div class="card-detail"><span class="detail-label"><i class="fa-solid fa-certificate"></i> Documents</span><span class="detail-value" style="font-size:12px">${p.certificates}</span></div>`:''}
              ${p.title==='NEW CDC'?`
                <div class="card-detail"><span class="detail-label"><i class="fa-solid fa-wallet"></i> Fees</span><span class="detail-value">$${p.fees||'0'}</span></div>
                <div class="card-detail" style="border:none;margin-top:10px"><span class="detail-label">Payment Completion</span><span class="detail-value">${p.feesPercentage||'0'}%</span></div>
                <div class="progress-bar"><div class="progress" style="width:${p.feesPercentage||'0'}%;background:${(p.feesPercentage||0)<100?((p.feesPercentage||0)<50?'#ef4444':'#f59e0b'):'#10b981'}"></div></div>
              `:''}
            </div>
          </div>
        `;
        
        card.querySelector('.btn-edit').addEventListener('click', (e) => {
          e.stopPropagation();
          const profile = profiles.find(prof => prof.id === p.id);
          if (profile) editProfile(profile);
        });
        
        card.querySelector('.btn-delete').addEventListener('click', (e) => {
          e.stopPropagation();
          deleteProfile(p.id);
        });
        
        card.addEventListener('click',()=>{
          const titleText=p.title?`\n\nðŸ“‹ Document Type: ${p.title}`:'';
          const revText=p.revalidationType?`\nRevalidation Type: ${p.revalidationType}`:'';
          const certText=p.certificates?`\n\nðŸ“œ Certificates:\n${p.certificates}`:'';
          const passportText=p.passportNumber?`\n\nðŸ“‘ Passport:\nNumber: ${p.passportNumber}\nExpiry: ${p.passportExpiry||'N/A'}`:'';
          const remarkText=p.remark?`\n\nðŸ’¬ Remark:\n${p.remark}`:'';
          const newCDCText=p.title==='NEW CDC'
            ?`\n\nðŸ“ NEW CDC Details:\nNRC: ${p.nrc||'N/A'}\nFather: ${p.fatherName||'N/A'}\nMother: ${p.motherName||'N/A'}\nBirthdate: ${p.birthdate||'N/A'}\nPlace of Birth: ${p.placeOfBirth||'N/A'}\nMark: ${p.distinguishingMark||'N/A'}\nFees: $${p.fees||'0'}\nPaid: ${p.feesPercentage||'0'}%`
            :'';
          alert(`SEAMAN PROFILE\n------------------\nName: ${p.name}\nRank: ${p.rank}\nCDC: ${p.cdcNumber}\nPhone: ${p.phone}\nAddress: ${p.address}${titleText}${revText}${newCDCText}${certText}${passportText}${remarkText}`);
        });
        profileCards.appendChild(card);
      });
    }

    async function startWebcam(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        const video=document.createElement('video');
        video.srcObject=stream;video.autoplay=true;video.playsInline=true;
        webcamPreview.innerHTML='';webcamPreview.appendChild(video);
        capturePhoto.disabled=false;startCamera.disabled=true;
      }catch(err){alert('Unable to access webcam. Please check permissions.')}
    }

    function captureWebcam(){
      if(!stream) return;
      const video=webcamPreview.querySelector('video');
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      capturedPhoto=canvas.toDataURL('image/jpeg');profilePhoto.value=capturedPhoto;
      stream.getTracks().forEach(t=>t.stop());stream=null;
      const img=document.createElement('img');img.src=capturedPhoto;
      webcamPreview.innerHTML='';webcamPreview.appendChild(img);
      capturePhoto.disabled=true;retakePhoto.disabled=false;
    }

    function retakeWebcam(){
      capturedPhoto=null;profilePhoto.value='';
      webcamPreview.innerHTML='<i class="fa-solid fa-camera" style="font-size:60px;opacity:.5; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></i>';
      capturePhoto.disabled=true;retakePhoto.disabled=true;startCamera.disabled=false;
    }
  </script>
</body>
</html>
